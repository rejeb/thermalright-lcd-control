#!/bin/bash
# SPDX-License-Identifier: Apache-2.0
# Copyright Â© 2025 Rejeb Ben Rejeb

set -e

VENV_DIR="/opt/thermalright-lcd-control/venv"
CONFIG_DIR="/etc/thermalright-lcd-control"
APP_DIR="/usr/lib/thermalright-lcd-control"
THEMES_DIR="/usr/share/thermalright-lcd-control"
GUI_CONFIG_FILE="$CONFIG_DIR/gui_config.yaml"

# Colors for output
RED='\033[0;31m'
GREEN='\033[0;32m'
NC='\033[0m'

log_info() {
    echo -e "${GREEN}[INFO]${NC} $1"
}

log_error() {
    echo -e "${RED}[ERROR]${NC} $1"
}

# Function to recreate virtual environment
recreate_venv() {
    log_info "Recreating Python virtual environment..."

    # Remove existing venv
    if [ -d "$VENV_DIR" ]; then
        rm -rf "$VENV_DIR"
    fi

    # Create new venv
    python3 -m venv "$VENV_DIR"
    "$VENV_DIR/bin/pip3" install --upgrade pip

    log_info "Virtual environment recreated"
}

# Function to install Python dependencies
install_dependencies() {
    log_info "Installing Python dependencies..."

    cd "$APP_DIR"
    if command -v python3 >/dev/null 2>&1 && python3 -c "import tomllib" 2>/dev/null; then
        # Python 3.11+ with tomllib
        "$VENV_DIR/bin/pip3" install $(python3 -c "import tomllib; deps = tomllib.load(open('pyproject.toml', 'rb'))['project']['dependencies']; print(' '.join(deps))")
    else
        # Fallback for older versions
        "$VENV_DIR/bin/pip3" install requests>=2.0 PySide6>=6.5 hid~=1.0.8 psutil>=5.8.0 opencv-python>=4.12.0.88 pyusb>=1.3.1 pillow>=11.3.0 pyyaml>=6.0.2
    fi

    log_info "Dependencies installed successfully"
}

# Function to update user configurations
update_user_configs() {
    if [ -n "$SUDO_USER" ]; then
        USER_HOME=$(getent passwd "$SUDO_USER" | cut -d: -f6)
        USER_CONFIG_DIR="$USER_HOME/.config/thermalright-lcd-control"


        log_info "Updating user configurations for $SUDO_USER..."

        # Create user data directory
        mkdir -p "$USER_HOME/.local/share/thermalright-lcd-control"
        chown -R "$SUDO_USER":"$SUDO_USER" "$USER_HOME/.local/share/thermalright-lcd-control"
        # Create user log directory
        mkdir -p "$USER_HOME/.local/state/$APP_NAME"
        chown -R "$SUDO_USER":"$SUDO_USER" "$USER_HOME/.local/state/$APP_NAME"
        # Update user configuration directory
        mkdir -p "$USER_CONFIG_DIR"

        # Copy new configuration files (but don't overwrite if they exist and are newer)
        if [ -d "$CONFIG_DIR/config" ]; then
            if [ ! -d "$USER_CONFIG_DIR/config" ]; then
                log_info "Updating config.yaml..."
                cp -R $CONFIG_DIR/config "$USER_CONFIG_DIR/"
            else
                log_info "User config.yaml is newer, keeping existing version"
            fi
        fi

        # Update themes directory - always update with new themes
        if [ -d "$THEMES_DIR/themes" ]; then
            log_info "Updating user themes directory..."
            mkdir -p "$USER_CONFIG_DIR/themes"
            # Copy new themes
            cp -R "$THEMES_DIR/themes" "$USER_CONFIG_DIR/"
            log_info "User themes updated"
        fi

        # Update service configuration
        sed -i "s|@config_file@|\"$USER_CONFIG_DIR/config\"|g" /lib/systemd/system/thermalright-lcd-control.service

        # Update GUI config paths
        if [ -f "$GUI_CONFIG_FILE" ]; then
            sed -i "s|themes_dir: \"./resources/themes/presets\"|themes_dir: \"$USER_CONFIG_DIR/themes/presets\"|g" "$GUI_CONFIG_FILE"
            sed -i "s|backgrounds_dir: \"./resources/themes/backgrounds\"|backgrounds_dir: \"$USER_CONFIG_DIR/themes/backgrounds\"|g" "$GUI_CONFIG_FILE"
            sed -i "s|foregrounds_dir: \"./resources/themes/foregrounds\"|foregrounds_dir: \"$USER_CONFIG_DIR/themes/foregrounds\"|g" "$GUI_CONFIG_FILE"
            sed -i "s|service_config: \"./resources/config\"|service_config: \"$USER_CONFIG_DIR/config\"|g" "$GUI_CONFIG_FILE"
        fi

        # Fix ownership
        chown -R "$SUDO_USER":"$SUDO_USER" "$USER_CONFIG_DIR"

        log_info "User configurations updated successfully"
    fi
}

# Function to restart service
restart_services() {
    log_info "Restarting service..."

    # Stop service if running
    systemctl stop thermalright-lcd-control.service 2>/dev/null

    # Reload systemd
    systemctl daemon-reload

    # Enable service
    systemctl enable thermalright-lcd-control.service

    # Start service
    systemctl start thermalright-lcd-control.service

    log_info "Services restarted"
}

stop_and_disable_service() {
    log_info "Stopping service..."

    # Stop service if running
    systemctl stop thermalright-lcd-control.service 2>/dev/null

    log_info "Disable service..."

    # Stop service if running
    systemctl disable thermalright-lcd-control.service

    log_info "Service disabled"
}

setup_device() {
    VENV_DIR="/opt/thermalright-lcd-control/venv"
    PYTHONPATH="/usr/lib/thermalright-lcd-control:$PYTHONPATH"
    export PYTHONPATH
    $VENV_DIR/bin/python -m thermalright_lcd_control.device_init --config "$USER_CONFIG_DIR/config"
}

# Main installation/update process
main() {
    log_info "Starting thermalright-lcd-control installation/update..."

    # Always recreate virtual environment to ensure clean dependencies
    recreate_venv

    # Install dependencies
    install_dependencies

    # Configure permissions
    chown -R root:root "$VENV_DIR"
    chown -R root:root "$CONFIG_DIR"

    # Update user configurations
    update_user_configs

    setup_device

    local setup_status=$?

    echo "return status $setup_status"
    if [ $setup_status -eq 0 ]; then
       # Restart services
        restart_services

        log_info "Installation/update completed successfully!"
    else
        log_error "No supported device was found or Device configuration aborted!"

       # Restart services
        stop_and_disable_service
    fi
}

# Run main function
main "$@"